<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>MFS Portal</title>
    <!-- Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <!-- svg4everybody polyfill -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/svg4everybody/2.1.9/svg4everybody.min.js"></script>
    <script>svg4everybody();</script>
    <!-- Salesforce Canvas SDK -->
    <script src="https://mfsuk--dev.sandbox.lightning.force.com/canvas/sdk/js/canvas-all.js"></script>
    
    <!-- Canvas Parameter Extraction Script (CanvasDemo Pattern) -->
    <script>
    
    </script>

  </head>
  <body>
    <div id="root"></div>
    <div id="salesforce-echo" style="padding: 12px; font-family: Inter, sans-serif;"></div>
    <script type="module" src="/src/index.jsx"></script>
    
    <!-- Canvas Parameters Display Script -->
    <script>
     
       fetch('https://polariscopy.onrender.com/api/salesforce/echo/last')
    .then(r => r.json())
    .then(data => console.log('echo last', data))
    .catch(err => console.error(err));


      alert(data.recordId);
      (function() {
        // Display last payload posted to /api/salesforce/echo
        const echoEl = document.getElementById('salesforce-echo');
        const backendUrl = window.location.hostname === 'localhost'
          ? 'http://localhost:3001'
          : window.location.origin;

        fetch(backendUrl + '/api/salesforce/echo/last')
          .then(res => res.json())
          .then(data => {
            if (!echoEl) return;
            if (!data?.payload) {
              echoEl.textContent = 'No Salesforce echo payload received yet.';
              return;
            }
            echoEl.textContent = 'Last Salesforce Echo Payload: ' + JSON.stringify(data.payload, null, 2);
          })
          .catch(() => {
            if (echoEl) {
              echoEl.textContent = 'Failed to load Salesforce echo payload.';
            }
          });

        // Check for Canvas parameters in URL
        const params = new URLSearchParams(window.location.search);
        const canvasParams = {};
        let hasCanvasParams = false;

        // Extract all parameters
        for (const [key, value] of params) {
          canvasParams[key] = value;
          if (key === 'canvasToken' || key.startsWith('canvas_') || 
              key === 'userId' || key === 'userName' || key === 'orgId' || key === 'recordId') {
            hasCanvasParams = true;
          }
        }

        // Display alert if canvas parameters exist
        if (hasCanvasParams) {
          const alertMessage = 'Canvas Parameters Received:\n\n' + 
            JSON.stringify(canvasParams, null, 2);
          
          // Show alert immediately
          alert(alertMessage);
          
          // Also log to console
          console.log('[Canvas Parameters]', canvasParams);
          
          // Store in sessionStorage if not already there
          if (!sessionStorage.getItem('canvasContext')) {
            try {
              const context = {
                parameters: Object.fromEntries(
                  Array.from(params).filter(([k]) => k.startsWith('canvas_'))
                    .map(([k, v]) => [k.replace('canvas_', ''), v])
                ),
                user: {
                  userId: params.get('userId'),
                  userName: params.get('userName'),
                  email: params.get('userEmail'),
                },
                organization: {
                  organizationId: params.get('orgId'),
                  name: params.get('orgName'),
                },
                environment: {
                  instanceUrl: params.get('instanceUrl'),
                  recordId: params.get('recordId'),
                },
              };
              sessionStorage.setItem('canvasContext', JSON.stringify(context));
            } catch (err) {
              console.error('[Canvas] Failed to store context:', err);
            }
          }
        }
      })();
    </script>
  </body>
</html>

